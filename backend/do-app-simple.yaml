name: motionmavericks
region: syd1

services:
- name: frontend
  git:
    repo_clone_url: https://github.com/motionmavericks/app.git
    branch: main
  source_dir: frontend
  build_command: npm ci && npm run build
  run_command: npm start
  instance_size_slug: basic-xxs
  instance_count: 1
  http_port: 3001
  health_check:
    http_path: /api/health
    initial_delay_seconds: 45
    period_seconds: 10
    timeout_seconds: 10
    failure_threshold: 6
    success_threshold: 1
  envs:
  - key: NODE_ENV
    value: production
    scope: RUN_AND_BUILD_TIME
  - key: PORT
    value: "3001"
    scope: RUN_AND_BUILD_TIME
  - key: NEXT_PUBLIC_API_BASE
    value: ${APP_URL}/api
    scope: RUN_AND_BUILD_TIME
  - key: NEXT_PUBLIC_EDGE_BASE
    value: ${APP_URL}/edge
    scope: RUN_AND_BUILD_TIME
  # Secrets required at runtime (placeholders; set values in DO)
  - key: EDGE_SIGNING_KEY
    type: SECRET
    scope: RUN_TIME

- name: backend
  git:
    repo_clone_url: https://github.com/motionmavericks/app.git
    branch: main
  source_dir: backend
  build_command: npm ci && npm run build
  run_command: npm start
  instance_size_slug: basic-xxs
  instance_count: 1
  http_port: 3000
  health_check:
    http_path: /api/health
    initial_delay_seconds: 45
    period_seconds: 10
    timeout_seconds: 15
    failure_threshold: 6
    success_threshold: 1
  envs:
  - key: NODE_ENV
    value: production
    scope: RUN_AND_BUILD_TIME
  - key: PORT
    value: "3000"
    scope: RUN_AND_BUILD_TIME
  - key: WASABI_ENDPOINT
    value: https://s3.ap-southeast-2.wasabisys.com
    scope: RUN_TIME
  - key: WASABI_REGION
    value: ap-southeast-2
    scope: RUN_TIME
  - key: EDGE_PUBLIC_BASE
    value: ${APP_URL}/edge
    scope: RUN_TIME
  - key: STAGING_BUCKET
    value: mm-staging-au
    scope: RUN_TIME
  - key: MASTERS_BUCKET
    value: mm-masters-au
    scope: RUN_TIME
  - key: PREVIEWS_BUCKET
    value: mm-previews-au
    scope: RUN_TIME
  # Secrets required at runtime (placeholders; set values in DO)
  - key: POSTGRES_URL
    type: SECRET
    scope: RUN_TIME
  - key: REDIS_URL
    type: SECRET
    scope: RUN_TIME
  - key: WASABI_STAGING_ACCESS_KEY
    type: SECRET
    scope: RUN_TIME
  - key: WASABI_STAGING_SECRET
    type: SECRET
    scope: RUN_TIME
  - key: WASABI_MASTERS_ACCESS_KEY
    type: SECRET
    scope: RUN_TIME
  - key: WASABI_MASTERS_SECRET
    type: SECRET
    scope: RUN_TIME
  - key: WASABI_PREVIEWS_ACCESS_KEY
    type: SECRET
    scope: RUN_TIME
  - key: WASABI_PREVIEWS_SECRET
    type: SECRET
    scope: RUN_TIME
  - key: EDGE_SIGNING_KEY
    type: SECRET
    scope: RUN_TIME

- name: edge
  git:
    repo_clone_url: https://github.com/motionmavericks/app.git
    branch: main
  source_dir: edge
  build_command: npm ci && npm run build
  run_command: npm start
  instance_size_slug: basic-xxs
  instance_count: 1
  http_port: 8080
  health_check:
    http_path: /health
    initial_delay_seconds: 30
    period_seconds: 10
    timeout_seconds: 10
    failure_threshold: 5
    success_threshold: 1
  envs:
  - key: NODE_ENV
    value: production
    scope: RUN_AND_BUILD_TIME
  - key: PORT
    value: "8080"
    scope: RUN_TIME
  - key: WASABI_ENDPOINT
    value: https://s3.ap-southeast-2.wasabisys.com
    scope: RUN_TIME
  - key: WASABI_REGION
    value: ap-southeast-2
    scope: RUN_TIME
  - key: PREVIEWS_BUCKET
    value: mm-previews-au
    scope: RUN_TIME
  # Secrets required at runtime (placeholders; set values in DO)
  - key: EDGE_SIGNING_KEY
    type: SECRET
    scope: RUN_TIME

workers:
- name: preview-worker
  git:
    repo_clone_url: https://github.com/motionmavericks/app.git
    branch: main
  source_dir: worker
  build_command: npm ci && npm run build
  run_command: node dist/worker.js
  instance_size_slug: basic-xxs
  instance_count: 1
  envs:
  - key: PREVIEW_STREAM
    value: previews:build
    scope: RUN_TIME
  - key: PREVIEW_CONSUMER_GROUP
    value: previewers
    scope: RUN_TIME
  - key: WASABI_ENDPOINT
    value: https://s3.ap-southeast-2.wasabisys.com
    scope: RUN_TIME
  - key: WASABI_REGION
    value: ap-southeast-2
    scope: RUN_TIME
  - key: MASTERS_BUCKET
    value: mm-masters-au
    scope: RUN_TIME
  - key: PREVIEWS_BUCKET
    value: mm-previews-au
    scope: RUN_TIME
  - key: PREVIEW_PRESET
    value: "480p"
    scope: RUN_TIME
  - key: HLS_SEGMENT_SEC
    value: "4"
    scope: RUN_TIME
  # Secrets required at runtime (placeholders; set values in DO)
  - key: REDIS_URL
    type: SECRET
    scope: RUN_TIME
  - key: WASABI_MASTERS_ACCESS_KEY
    type: SECRET
    scope: RUN_TIME
  - key: WASABI_MASTERS_SECRET
    type: SECRET
    scope: RUN_TIME
  - key: WASABI_PREVIEWS_ACCESS_KEY
    type: SECRET
    scope: RUN_TIME
  - key: WASABI_PREVIEWS_SECRET
    type: SECRET
    scope: RUN_TIME

ingress:
  rules:
  - match:
      path:
        prefix: /api
    component:
      name: backend
  - match:
      path:
        prefix: /edge
    component:
      name: edge
  - match:
      path:
        prefix: /
    component:
      name: frontend